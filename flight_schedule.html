<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HSM Schedule App</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
    text-align: center;
}
button {
    padding: 14px;
    font-size: 16px;
    width: 100%;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    background-color: #007AFF;
    color: white;
}
input {
    margin-top: 20px;
}
.card {
    margin-top: 20px;
    padding: 15px;
    border-radius: 12px;
    background: #f2f2f7;
}
</style>
</head>
<body>

<h2>HSM Schedule → Calendar</h2>

<input type="file" id="pdfUpload" accept="application/pdf">
<button onclick="processPDF()">Generate Calendar Event</button>

<div id="result"></div>

<script>
const LAST_NAME = "BRAWER";

async function processPDF() {

    const fileInput = document.getElementById('pdfUpload');
    if (!fileInput.files.length) {
        alert("Upload the schedule PDF.");
        return;
    }

    const file = fileInput.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    let scheduleDate = null;
    let foundEvent = null;

    for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();

        const pageText = content.items.map(i => i.str).join(" ");

        if (!scheduleDate) {
            const dateMatch = pageText.match(/DATE:\s+(\d{1,2}\s+\w+\s+\d{4})/);
            if (dateMatch) scheduleDate = new Date(dateMatch[1]);
        }

        let rows = {};
        content.items.forEach(item => {
            const y = Math.round(item.transform[5]);
            if (!rows[y]) rows[y] = [];
            rows[y].push(item);
        });

        Object.values(rows).forEach(rowItems => {
            const rowText = rowItems
                .sort((a, b) => a.transform[4] - b.transform[4])
                .map(i => i.str)
                .join(" ");

            if (rowText.includes(LAST_NAME)) {

                const times = rowText.match(/\b\d{4}\b/g);
                if (!times || times.length < 3) return;

                const brf = times[0];
                const etd = times[1];
                const eta = times[2];

                const evtMatch = rowText.match(/^\s*(\d+)\s+(.*?)(\d{4})/);
                let evtNumber = "";
                let evtName = "Event";

                if (evtMatch) {
                    evtNumber = evtMatch[1];
                    evtName = evtMatch[2].trim();
                }

                const type = p === 2 ? "SIM" : "FLT";

                foundEvent = {
                    type,
                    number: evtNumber,
                    name: evtName,
                    brf,
                    etd,
                    eta,
                    rowText
                };
            }
        });
    }

    if (!scheduleDate || !foundEvent) {
        alert("Could not detect your event.");
        return;
    }

    const ics = buildICS(scheduleDate, foundEvent);
    downloadICS(ics);

    document.getElementById("result").innerHTML =
        `<div class="card">
        <strong>${foundEvent.type} ${foundEvent.number}</strong><br>
        ${foundEvent.name}<br><br>
        ${foundEvent.brf} – ${foundEvent.eta}
        </div>`;
}

function buildICS(date, e) {
    const start = formatICSDate(date, e.brf);
    const end = formatICSDate(date, e.eta);

    let ics = "BEGIN:VCALENDAR\nVERSION:2.0\n";
    ics += "BEGIN:VEVENT\n";
    ics += `SUMMARY:${e.type} ${e.number} – ${e.name}\n`;
    ics += `DTSTART:${start}\n`;
    ics += `DTEND:${end}\n`;
    ics += `DESCRIPTION:Brief ${e.brf}\\nETD ${e.etd}\\nETA ${e.eta}\n`;
    ics += "END:VEVENT\nEND:VCALENDAR";

    return ics;
}

function formatICSDate(date, time) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}T${time}00`;
}

function downloadICS(content) {
    const blob = new Blob([content], { type: "text/calendar" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "hsm_event.ics";
    link.click();
}
</script>

</body>
</html>
